{% extends 'base.html' %}
{% load static %}

{% block title %}{{ survey.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'surveys/css/survey_detail_google_form.css' %}">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    .ql-editor {
        min-height: 100px;
        max-height: 300px;
        overflow-y: auto;
    }
    .ql-toolbar {
        border-top-left-radius: 0.25rem;
        border-top-right-radius: 0.25rem;
    }
    .ql-container {
        border-bottom-left-radius: 0.25rem;
        border-bottom-right-radius: 0.25rem;
    }
    /* Style cho HTML content được render */
    .text-muted strong { font-weight: 600; }
    .text-muted em { font-style: italic; }
    .text-muted u { text-decoration: underline; }
    .text-muted ol, .text-muted ul { 
        margin: 0.5rem 0;
        padding-left: 1.5rem;
    }
    .text-muted a {
        color: #0d6efd;
        text-decoration: underline;
    }
    /* Style cho subtitle editor inline */
    .subtitle-editor-section {
        padding: 0.75rem;
        background-color: #f8f9fa;
        border-radius: 0.375rem;
    }
    .subtitle-editor-inline .ql-editor {
        min-height: 80px;
        max-height: 200px;
        background-color: white;
    }
    .subtitle-editor-inline .ql-toolbar {
        background-color: white;
    }
    .progress {
        height: 35px;
        background-color: #e9ecef;
        border-radius: 0.5rem;
        overflow: hidden;
        position: relative;
    }
    .progress-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
        color: white;
        background: linear-gradient(90deg, #0d6efd 0%, #0a58ca 100%);
        transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
        min-width: 0;
        white-space: nowrap;
        animation: progressSlide 1.5s ease-out;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
    }
    
    @keyframes progressSlide {
        0% {
            width: 0 !important;
            opacity: 0.8;
        }
        100% {
            opacity: 1;
        }
    }
    
    .progress-bar.full-width {
        width: 100% !important;
    }
    
    /* Style cho chart */
    .chart-container {
        position: relative;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 0.5rem;
    }
    
    .chart-wrapper {
        display: flex;
        gap: 2rem;
        align-items: flex-start;
    }
    
    .chart-canvas {
        flex: 0 0 300px;
        max-width: 300px;
    }
    
    .chart-data {
        flex: 1;
        min-width: 0;
    }
    
    .chart-type-toggle {
        margin-bottom: 1rem;
    }
    
    @media (max-width: 768px) {
        .chart-wrapper {
            flex-direction: column;
        }
        .chart-canvas {
            flex: 0 0 auto;
            max-width: 100%;
            margin: 0 auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 900px;">
    <div class="card mb-4" style="border: none; box-shadow: 0 1px 2px rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);">
        {% if survey.header_image %}
        <div class="position-relative" style="max-height: 260px; overflow: hidden; border-radius: 15px 15px 0 0;">
            <img src="{{ survey.header_image.url }}" alt="Ảnh tiêu đề khảo sát"
                 class="w-100" style="object-fit: cover; height: 260px;">
        </div>
        {% endif %}
        <div class="card-body">
            <h1 class="mb-3" style="font-size: 32px; font-weight: 400; color: #202124;">
                {{ survey.title }}
            </h1>
            {% if survey.description %}
            <p class="text-muted mb-3">{{ survey.description }}</p>
            {% endif %}
            <div class="d-flex gap-3 align-items-center">
                <span class="badge bg-secondary">{{ survey.responses.count }} phản hồi</span>
                <span id="surveyStatusBadge" class="badge {% if survey.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                    {% if survey.is_active %}Đang hoạt động{% else %}Nháp{% endif %}
                </span>
            </div>
        </div>
    </div>

    {% if can_edit %}
    <div class="card mb-4" style="border: none; box-shadow: 0 1px 2px rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);">
        <div class="card-body p-0">
            <ul class="nav nav-tabs border-0" id="surveyTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="questions-tab" data-bs-toggle="tab" data-bs-target="#questions-pane" type="button" role="tab">
                        <i class="bi bi-question-circle"></i> Câu hỏi
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results-pane" type="button" role="tab">
                        <i class="bi bi-graph-up"></i> Kết quả
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="export-tab" data-bs-toggle="tab" data-bs-target="#export-pane" type="button" role="tab">
                        <i class="bi bi-file-earmark-arrow-down"></i> Xuất file
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings-pane" type="button" role="tab">
                        <i class="bi bi-gear"></i> Cài đặt
                    </button>
                </li>
                {% if user_role == 'owner' %}
                <li class="nav-item ms-auto">
                    <a class="nav-link" href="{% url 'surveys:survey_collaborators' survey.pk %}">
                        <i class="bi bi-people"></i> Cộng tác viên
                    </a>
                </li>
                {% endif %}
            </ul>
        </div>
    </div>

    <div class="tab-content" id="surveyTabContent">
        <div class="tab-pane fade show active" id="questions-pane" role="tabpanel">
            <div id="questions-container" data-survey-id="{{ survey.pk }}">
        {% for question in questions %}
        <div class="question-item" data-question-id="{{ question.id }}" data-order="{{ question.order }}">
            <div class="question-header">
                <i class="bi bi-grip-vertical drag-handle"></i>
                <span class="question-number">{{ forloop.counter }}.</span>
                <input type="text" class="question-text" value="{{ question.text }}" 
                       data-question-id="{{ question.id }}" placeholder="Câu hỏi">
                {% if question.question_type == 'text' or question.question_type == 'single' or question.question_type == 'multiple' or question.question_type == 'upload' %}
                <select class="question-type-select" data-question-id="{{ question.id }}">
                    <optgroup label="Câu hỏi">
                        <option value="text" {% if question.question_type == 'text' %}selected{% endif %}>Tự luận</option>
                        <option value="single" {% if question.question_type == 'single' %}selected{% endif %}>Chọn một</option>
                        <option value="multiple" {% if question.question_type == 'multiple' %}selected{% endif %}>Chọn nhiều</option>
                        <option value="upload" {% if question.question_type == 'upload' %}selected{% endif %}>Tải tệp (ảnh/video)</option>
                    </optgroup>
                </select>
                {% else %}
                <span class="badge bg-secondary ms-2">
                    {% if question.question_type == 'section' or question.question_type == 'description' %}
                        Tiêu đề/Mô tả
                    {% elif question.question_type == 'image' %}
                        Hình ảnh
                    {% elif question.question_type == 'video' %}
                        Video
                    {% endif %}
                </span>
                {% endif %}
                <div class="question-actions d-flex align-items-center gap-2">
                    {% if question.question_type == 'text' or question.question_type == 'single' or question.question_type == 'multiple' or question.question_type == 'upload' %}
                    <div class="form-check form-switch mb-0">
                        <input class="form-check-input required-toggle" type="checkbox" role="switch"
                               id="required_{{ question.id }}"
                               {% if question.is_required %}checked{% endif %}
                               onchange="toggleRequired({{ question.id }}, this)">
                        <label class="form-check-label small text-muted" for="required_{{ question.id }}">Bắt buộc</label>
                    </div>
                    {% endif %}
                    <button class="btn-icon" onclick="duplicateQuestion({{ question.id }})" title="Nhân bản câu hỏi">
                        <i class="bi bi-files"></i>
                    </button>
                    <button class="btn-icon" onclick="deleteQuestion({{ question.id }})" title="Xóa">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </div>
            
            {% if question.question_type == 'single' or question.question_type == 'multiple' %}
                <div class="choices-container" data-question-id="{{ question.id }}">
                    {% for choice in question.options %}
                    <div class="choice-item" data-choice-id="{{ forloop.counter0 }}">
                        <i class="bi bi-{% if question.question_type == 'single' %}circle{% else %}square{% endif %}"></i>
                        <input type="text" class="choice-input" value="{{ choice }}" 
                               placeholder="Lựa chọn" data-choice-id="{{ forloop.counter0 }}">
                        <button class="btn-icon" onclick="deleteChoice({{ question.id }}, {{ forloop.counter0 }})">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                    {% endfor %}
                    <button class="btn btn-sm btn-link p-0 mt-2" onclick="addChoice({{ question.id }})">
                        <i class="bi bi-plus"></i> Thêm lựa chọn
                    </button>
                </div>
            {% endif %}
            
            {% if question.question_type == 'description' or question.question_type == 'section' %}
            <div class="mt-3 subtitle-editor-section" data-question-id="{{ question.id }}">
                <label class="form-label small text-muted">Mô tả (không bắt buộc)</label>
                <div id="subtitle-editor-{{ question.id }}" class="subtitle-editor-inline">{{ question.subtitle|default:""|safe }}</div>
            </div>
            {% elif question.question_type == 'image' %}
            <div class="mt-3">
                {% if question.media_url %}
                <img src="{{ question.media_url }}" alt="{{ question.subtitle|default:'Image' }}" class="img-fluid rounded mb-2">
                {% else %}
                <div class="alert alert-info mb-2">
                    <small>Chưa có hình ảnh. Vui lòng upload ảnh.</small>
                </div>
                {% endif %}
                <div class="subtitle-editor-section" data-question-id="{{ question.id }}">
                    <label class="form-label small text-muted">Mô tả/Phụ đề (không bắt buộc)</label>
                    <div id="subtitle-editor-{{ question.id }}" class="subtitle-editor-inline">{{ question.subtitle|default:""|safe }}</div>
                </div>
            </div>
            {% elif question.question_type == 'video' %}
            <div class="mt-3">
                {% if question.media_url %}
                <div class="ratio ratio-16x9 mb-2">
                    <iframe src="{{ question.media_url }}" allowfullscreen title="{{ question.subtitle|default:'Video' }}"></iframe>
                </div>
                {% else %}
                <div class="alert alert-info mb-2">
                    <small>Chưa có link video. Vui lòng thêm link video.</small>
                </div>
                {% endif %}
                <div class="subtitle-editor-section" data-question-id="{{ question.id }}">
                    <label class="form-label small text-muted">Mô tả/Phụ đề (không bắt buộc)</label>
                    <div id="subtitle-editor-{{ question.id }}" class="subtitle-editor-inline">{{ question.subtitle|default:""|safe }}</div>
                </div>
            </div>
            {% endif %}
        </div>
            {% endfor %}
            </div>

    {% if can_edit %}
    <div class="builder-toolbar position-fixed" style="top: 140px; right: 40px; z-index: 1030;">
        <div class="bg-white shadow rounded-3 d-flex flex-column align-items-center py-3 px-2 gap-3">
            <button type="button" class="btn btn-light p-2" title="Thêm câu hỏi" onclick="showAddQuestionForm(null)">
                <i class="bi bi-plus-lg"></i>
            </button>
            <hr class="w-100 my-1">
            <button type="button" class="btn btn-light p-2" title="Thêm tiêu đề/mô tả" onclick="showAddQuestionForm('section')">
                <span class="fw-bold">Tt</span>
            </button>
            <button type="button" class="btn btn-light p-2" title="Thêm hình ảnh" onclick="showAddQuestionForm('image')">
                <i class="bi bi-image"></i>
            </button>
            <button type="button" class="btn btn-light p-2" title="Thêm video" onclick="showAddQuestionForm('video')">
                <i class="bi bi-play-btn"></i>
            </button>
        </div>
    </div>
    {% endif %}

            {% if survey.is_active and not is_expired %}
            <div class="text-center mt-4">
                <a href="{% url 'surveys:survey_take' survey.pk %}" class="btn btn-primary btn-lg">
                    <i class="bi bi-eye"></i> Xem trước khảo sát
                </a>
            </div>
            {% endif %}
        </div>

        <div class="tab-pane fade" id="results-pane" role="tabpanel">
            <div class="card mb-4" style="border: none; box-shadow: 0 1px 2px rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);">
                <div class="card-body">
                    <h4 class="mb-4">
                        <i class="bi bi-graph-up"></i> Kết quả khảo sát
                    </h4>
                    <div class="row text-center mb-4">
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-number">{{ total_responses|default:0 }}</div>
                                <small class="text-muted">Tổng số phản hồi</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-number">{{ questions.count }}</div>
                                <small class="text-muted">Số câu hỏi</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stat-card">
                                <div class="stat-number">{{ survey.responses.count }}</div>
                                <small class="text-muted">Người tham gia</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if stats %}
            {% for stat in stats %}
            <div class="card mb-4" style="border: none; box-shadow: 0 1px 2px rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        Câu {{ forloop.counter }}: {{ stat.question.text }}
                        <span class="badge bg-secondary">{{ stat.question.get_question_type_display }}</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if stat.type == 'text' %}
                    <p class="text-muted">Tổng số câu trả lời: {{ stat.total }}</p>
                    <div class="list-group">
                        {% for answer in stat.answers %}
                        <div class="list-group-item">
                            <div class="d-flex align-items-start">
                                <span class="badge bg-primary me-2">{{ forloop.counter }}</span>
                                <div class="flex-grow-1">{{ answer }}</div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="alert alert-info">Chưa có câu trả lời nào</div>
                        {% endfor %}
                    </div>
                    {% if stat.total > 10 %}
                    <p class="text-muted mt-2">
                        <small>Hiển thị 10 câu trả lời đầu tiên trong tổng số {{ stat.total }} câu trả lời</small>
                    </p>
                    {% endif %}
                    
                    {% elif stat.type == 'upload' %}
                    <p class="text-muted">Tổng số tệp đã tải lên: {{ stat.total }}</p>
                    <div class="list-group">
                        {% for att in stat.attachments %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="text-truncate me-3">
                                <i class="bi bi-paperclip"></i>
                                {{ att.original_name|default:att.file.name }}
                            </div>
                            <a class="btn btn-sm btn-outline-primary" href="{{ att.file.url }}" target="_blank" rel="noopener">
                                <i class="bi bi-box-arrow-up-right"></i> Mở
                            </a>
                        </div>
                        {% empty %}
                        <div class="alert alert-info">Chưa có tệp nào</div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted mb-3">Tổng số phản hồi: {{ stat.total }}</p>
                    
                    <!-- Chart Container -->
                    <div class="chart-container">
                        <div class="chart-type-toggle">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary active" onclick="switchChart({{ forloop.counter }}, 'doughnut')">
                                    <i class="bi bi-pie-chart"></i> Biểu đồ tròn
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="switchChart({{ forloop.counter }}, 'bar')">
                                    <i class="bi bi-bar-chart"></i> Biểu đồ cột
                                </button>
                            </div>
                        </div>
                        
                        <div class="chart-wrapper">
                            <div class="chart-canvas">
                                <canvas id="chart-{{ forloop.counter }}" data-chart-id="{{ forloop.counter }}"></canvas>
                            </div>
                            
                            <div class="chart-data">
                                {% for choice_stat in stat.choices %}
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>{{ choice_stat.option }}</span>
                                        <span class="fw-bold">{{ choice_stat.count }} ({{ choice_stat.percentage }}%)</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar {% if choice_stat.percentage == 100 %}full-width{% endif %}" 
                                             role="progressbar" 
                                             data-percentage="{{ choice_stat.percentage }}"
                                             style="width: 0%"
                                             aria-valuenow="{{ choice_stat.percentage }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {{ choice_stat.percentage }}%
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Chưa có dữ liệu kết quả nào.
            </div>
            {% endif %}
        </div>

        <!-- Tab: Xuất file -->
        <div class="tab-pane fade" id="export-pane" role="tabpanel">
            <div class="card mb-4" style="border: none; box-shadow: 0 1px 2px rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);">
                <div class="card-body">
                    <h4 class="mb-3">
                        <i class="bi bi-file-earmark-arrow-down"></i> Xuất dữ liệu khảo sát
                    </h4>
                    <p class="text-muted">
                        Tải xuống toàn bộ câu trả lời của khảo sát dưới nhiều định dạng:
                    </p>
                    <div class="d-flex flex-wrap gap-2 mt-3">
                        <a href="{% url 'surveys:survey_export_excel' survey.pk %}" class="btn btn-success">
                            <i class="bi bi-file-earmark-excel"></i> Tải file Excel (.xlsx)
                        </a>
                        <a href="{% url 'surveys:survey_results' survey.pk %}" class="btn btn-outline-primary">
                            <i class="bi bi-graph-up"></i> Xem trang kết quả chi tiết
                        </a>
                    </div>
                    <hr>
                    <small class="text-muted">
                        Lưu ý: dữ liệu trong file sẽ ẩn danh người dùng không đăng nhập, chỉ hiển thị IP hoặc để trống nếu không có.
                    </small>
                </div>
            </div>
        </div>

        <!-- Tab: Cài đặt -->
        <div class="tab-pane fade" id="settings-pane" role="tabpanel">
            <div class="card mb-4" style="border: none; box-shadow: 0 1px 2px rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);">
                <div class="card-body">
                    <h4 class="mb-4">
                        <i class="bi bi-gear"></i> Cài đặt khảo sát
                    </h4>
                    <form method="post" action="{% url 'surveys:survey_edit' survey.pk %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="id_title" class="form-label">Tiêu đề</label>
                            <input type="text" class="form-control" id="id_title" name="title" value="{{ survey.title }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="id_description" class="form-label">Mô tả</label>
                            <textarea class="form-control" id="id_description" name="description" rows="4">{{ survey.description }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label for="id_header_image" class="form-label">Ảnh tiêu đề</label>
                            {% if survey.header_image %}
                            <div class="mb-2">
                                <img src="{{ survey.header_image.url }}" alt="Ảnh hiện tại" class="img-thumbnail" style="max-height: 150px;">
                            </div>
                            {% endif %}
                            <input type="file" class="form-control" id="id_header_image" name="header_image" accept="image/*">
                            <small class="text-muted">Để trống nếu không muốn thay đổi</small>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="id_is_active" name="is_active" {% if survey.is_active %}checked{% endif %}>
                                <label class="form-check-label" for="id_is_active">
                                    Đang hoạt động
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="id_max_responses" class="form-label">Giới hạn số phản hồi</label>
                            <input type="number" class="form-control" id="id_max_responses" name="max_responses" min="1" placeholder="Ví dụ: 100"
                                   value="{{ survey.max_responses|default_if_none:'' }}">
                            <small class="text-muted">Để trống nếu không giới hạn số lượt làm khảo sát</small>
                        </div>
                        <div class="mb-3">
                            <label for="id_whitelist_emails" class="form-label">Whitelist email (mỗi dòng một email)</label>
                            <textarea class="form-control" id="id_whitelist_emails" name="whitelist_emails" rows="4" placeholder="vd: user1@gmail.com&#10;user2@gmail.com">{{ survey.whitelist_emails }}</textarea>
                            <small class="text-muted">Chỉ các email này được tham gia và export kết quả. Để trống nếu không giới hạn.</small>
                        </div>
                        <div class="mb-4">
                            <label for="id_password" class="form-label">Mật khẩu khảo sát (tuỳ chọn)</label>
                            <input type="password" class="form-control" id="id_password" name="password" placeholder="Nhập mật khẩu mới nếu muốn cập nhật">
                            <small class="text-muted">Để trống nếu giữ nguyên / không dùng mật khẩu.</small>
                        </div>
                        <div class="mb-3">
                            <label for="id_starts_at" class="form-label">Bắt đầu khảo sát</label>
                            <input type="datetime-local" class="form-control" id="id_starts_at" name="starts_at"
                                   value="{% if survey.starts_at %}{{ survey.starts_at|date:'Y-m-d\\TH:i' }}{% endif %}">
                            <small class="text-muted">Để trống nếu cho phép tham gia ngay</small>
                        </div>
                        <div class="mb-3">
                            <label for="id_expires_at" class="form-label">Hết hạn vào</label>
                            <input type="datetime-local" class="form-control" id="id_expires_at" name="expires_at" 
                                   value="{% if survey.expires_at %}{{ survey.expires_at|date:'Y-m-d\TH:i' }}{% endif %}">
                        </div>

                        <hr class="my-4">

                        <h5 class="mb-3">
                            <i class="bi bi-repeat"></i> Giới hạn trả lời
                        </h5>

                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="id_one_response_only" name="one_response_only" {% if survey.one_response_only %}checked{% endif %}>
                                <label class="form-check-label" for="id_one_response_only">
                                    <strong>Chỉ cho phép trả lời 1 lần</strong>
                                </label>
                            </div>
                            <small class="text-muted">Mỗi người chỉ được trả lời 1 lần. TẮT để cho phép trả lời nhiều lần</small>
                        </div>

                        <hr class="my-4">

                        <h5 class="mb-3">
                            <i class="bi bi-toggles"></i> Tùy chọn sau khi hoàn thành
                        </h5>

                        <div class="mb-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="id_allow_review_response" name="allow_review_response" {% if survey.allow_review_response %}checked{% endif %}>
                                <label class="form-check-label" for="id_allow_review_response">
                                    <strong>Cho phép xem lại câu trả lời</strong>
                                </label>
                            </div>
                            <small class="text-muted">Người trả lời có thể xem lại câu trả lời của mình sau khi gửi</small>
                        </div>

                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="id_send_confirmation_email" name="send_confirmation_email" {% if survey.send_confirmation_email %}checked{% endif %}>
                                <label class="form-check-label" for="id_send_confirmation_email">
                                    <strong>Gửi email xác nhận</strong>
                                </label>
                            </div>
                            <small class="text-muted" id="emailHelpTextBuilder">Gửi email cảm ơn đến người trả lời (chỉ hoạt động khi TẮT tính năng xem lại câu trả lời)</small>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save"></i> Lưu thay đổi
                            </button>
                            <a href="{% url 'surveys:survey_detail' survey.pk %}" class="btn btn-secondary">
                                <i class="bi bi-x"></i> Hủy
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="addQuestionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-title">Thêm câu hỏi mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
                <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label" id="new-question-text-label">Nội dung câu hỏi</label>
                    <input type="text" class="form-control" id="new-question-text" placeholder="Nhập câu hỏi">
                </div>
                <div class="mb-3" id="question-type-container">
                    <label class="form-label">Loại câu hỏi</label>
                    <select class="form-select" id="new-question-type">
                        <option value="text">Tự luận</option>
                        <option value="single" selected>Chọn một</option>
                        <option value="multiple">Chọn nhiều</option>
                        <option value="upload">Tải tệp (ảnh/video)</option>
                    </select>
                </div>
                
                <div class="mb-3" id="content-type-container" style="display: none;">
                    <label class="form-label">Loại nội dung</label>
                    <select class="form-select" id="new-content-type">
                        <option value="section">Tiêu đề/Mô tả</option>
                        <option value="image">Hình ảnh</option>
                        <option value="video">Video</option>
                    </select>
                </div>
                <div class="mb-3" id="new-question-subtitle" style="display:none;">
                    <label class="form-label" id="new-question-subtitle-label">Mô tả/Phụ đề</label>
                    <div id="subtitle-editor-container">
                        <div id="subtitle-editor"></div>
                    </div>
                    <small class="text-muted">Không bắt buộc. Bạn có thể định dạng văn bản (in đậm, nghiêng, gạch chân...)</small>
                </div>
                <div class="mb-3" id="new-question-media" style="display:none;">
                    <label class="form-label">Link video (YouTube embed link)</label>
                    <input type="text" class="form-control" id="new-question-media-link" placeholder="Dán link video (nếu là loại Video)">
                </div>
                <div class="mb-3" id="new-question-image-file" style="display:none;">
                    <label class="form-label">Ảnh từ máy tính</label>
                    <input type="file" class="form-control" id="new-question-image-input" accept="image/*">
                </div>
                <div id="new-question-choices" style="display: none;">
                    <label class="form-label">Lựa chọn</label>
                    <div id="choices-list">
                        <div class="input-group mb-2">
                            <input type="text" class="form-control choice-input-new" placeholder="Lựa chọn 1">
                        </div>
                        <div class="input-group mb-2">
                            <input type="text" class="form-control choice-input-new" placeholder="Lựa chọn 2">
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-link" onclick="addNewChoiceInput()">
                        <i class="bi bi-plus"></i> Thêm lựa chọn
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveNewQuestion()">Thêm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const surveyId = Number('{{ survey.pk }}');
const csrfToken = '{{ csrf_token }}';
// Quiz mode is disabled globally
const surveyIsQuiz = false;

// Prevent selecting past datetime in builder settings (starts_at / expires_at)
function toDatetimeLocalValue(d) {
    const pad = (n) => String(n).padStart(2, '0');
    const yyyy = d.getFullYear();
    const mm = pad(d.getMonth() + 1);
    const dd = pad(d.getDate());
    const hh = pad(d.getHours());
    const mi = pad(d.getMinutes());
    return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
}

document.addEventListener('DOMContentLoaded', function () {
    const nowVal = toDatetimeLocalValue(new Date());
    const startsInput = document.getElementById('id_starts_at');
    const expiresInput = document.getElementById('id_expires_at');
    if (startsInput) startsInput.min = nowVal;
    if (expiresInput) expiresInput.min = nowVal;

    if (startsInput && expiresInput) {
        const syncExpiresMin = () => {
            const startVal = startsInput.value;
            if (startVal) {
                expiresInput.min = startVal > nowVal ? startVal : nowVal;
            } else {
                expiresInput.min = nowVal;
            }
        };
        startsInput.addEventListener('change', syncExpiresMin);
        syncExpiresMin();
    }
});

// Biến lưu trữ Quill editor instance
let subtitleQuillEditor = null;
let currentModalType = null; // Lưu loại modal hiện tại
let inlineSubtitleEditors = {}; // Lưu các editor inline cho mỗi câu hỏi

// Chart data storage
const chartInstances = {};
const chartData = {
    {% for stat in stats %}
    {% if stat.type == 'single' or stat.type == 'multiple' %}
    {{ forloop.counter }}: {
        labels: [{% for choice_stat in stat.choices %}'{{ choice_stat.option|escapejs }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
        data: [{% for choice_stat in stat.choices %}{{ choice_stat.count }}{% if not forloop.last %}, {% endif %}{% endfor %}]
    },
    {% endif %}
    {% endfor %}
};

// Initialize Sortable for drag & drop
{% if can_edit %}
let sortable = Sortable.create(document.getElementById('questions-container'), {
    handle: '.drag-handle',
    animation: 150,
    onEnd: function(evt) {
        saveQuestionOrder();
    }
});
{% endif %}

// Initialize inline subtitle editors for existing questions
function initInlineSubtitleEditors() {
    document.querySelectorAll('.subtitle-editor-inline').forEach(editorDiv => {
        const questionId = editorDiv.id.replace('subtitle-editor-', '');
        
        if (inlineSubtitleEditors[questionId]) {
            return; // Already initialized
        }
        
        const toolbarOptions = [
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['link'],
            ['clean']
        ];
        
        const editor = new Quill(`#${editorDiv.id}`, {
            theme: 'snow',
            modules: {
                toolbar: toolbarOptions
            },
            placeholder: 'Nhập mô tả...'
        });
        
        inlineSubtitleEditors[questionId] = editor;
        
        // Auto-save on text change
        let saveTimeout;
        editor.on('text-change', function() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                const html = editor.root.innerHTML;
                updateQuestion(questionId, {subtitle: html});
            }, 1500);
        });
    });
}

// Initialize all editors on page load
initInlineSubtitleEditors();

// Auto-save question text
document.querySelectorAll('.question-text').forEach(input => {
    let timeout;
    input.addEventListener('input', function() {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            updateQuestion(input.dataset.questionId, {text: input.value});
        }, 1000);
    });
});

// Auto-save question type
document.querySelectorAll('.question-type-select').forEach(select => {
    select.addEventListener('change', function() {
        const questionId = this.dataset.questionId;
        const questionType = this.value;
        updateQuestionType(questionId, questionType);
    });
});

// Auto-save choice text
document.querySelectorAll('.choice-input').forEach(input => {
    let timeout;
    input.addEventListener('input', function() {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            updateChoice(input.dataset.choiceId, input.value);
        }, 1000);
    });
});

function attachChoiceFocus() {
    document.querySelectorAll('.choice-item').forEach(item => {
        if (item.dataset.focusBound) return;
        const input = item.querySelector('.choice-input');
        if (!input) return;
        item.dataset.focusBound = '1';
        item.addEventListener('click', function (evt) {
            if (evt.target.closest('button')) return;
            input.focus();
            input.select();
        });
    });
}
attachChoiceFocus();

function showAddQuestionForm(defaultType) {
    const modal = new bootstrap.Modal(document.getElementById('addQuestionModal'));
    const modalTitle = document.getElementById('modal-title');
    const questionTypeContainer = document.getElementById('question-type-container');
    const contentTypeContainer = document.getElementById('content-type-container');
    const questionTypeSelect = document.getElementById('new-question-type');
    const contentTypeSelect = document.getElementById('new-content-type');
    const choicesBlock = document.getElementById('new-question-choices');
    const subtitleBlock = document.getElementById('new-question-subtitle');
    const mediaBlock = document.getElementById('new-question-media');
    const imageFileBlock = document.getElementById('new-question-image-file');
    const textLabel = document.getElementById('new-question-text-label');
    const textInput = document.getElementById('new-question-text');
    const subtitleLabel = document.getElementById('new-question-subtitle-label');
    
    // Reset tất cả các block
    subtitleBlock.style.display = 'none';
    mediaBlock.style.display = 'none';
    imageFileBlock.style.display = 'none';
    choicesBlock.style.display = 'none';
    
    // Reset input
    textInput.value = '';

    // Xác định loại và hiển thị UI tương ứng
    if (defaultType === 'section') {
        // Thêm Tiêu đề/Mô tả: ẩn cả 2 dropdown, hiển thị trực tiếp
        currentModalType = 'section';
        modalTitle.textContent = 'Thêm tiêu đề/mô tả';
        questionTypeContainer.style.display = 'none';
        contentTypeContainer.style.display = 'none';
        subtitleBlock.style.display = 'block';
        textLabel.textContent = 'Tiêu đề';
        textInput.placeholder = 'Nhập tiêu đề';
        subtitleLabel.textContent = 'Mô tả (không bắt buộc)';
    } else if (defaultType === 'image') {
        // Thêm hình ảnh
        currentModalType = 'image';
        modalTitle.textContent = 'Thêm hình ảnh';
        questionTypeContainer.style.display = 'none';
        contentTypeContainer.style.display = 'none';
        subtitleBlock.style.display = 'block';
        imageFileBlock.style.display = 'block';
        textLabel.textContent = 'Tiêu đề';
        textInput.placeholder = 'Nhập tiêu đề';
        subtitleLabel.textContent = 'Mô tả/Phụ đề (không bắt buộc)';
    } else if (defaultType === 'video') {
        // Thêm video
        currentModalType = 'video';
        modalTitle.textContent = 'Thêm video';
        questionTypeContainer.style.display = 'none';
        contentTypeContainer.style.display = 'none';
        subtitleBlock.style.display = 'block';
        mediaBlock.style.display = 'block';
        textLabel.textContent = 'Tiêu đề';
        textInput.placeholder = 'Nhập tiêu đề';
        subtitleLabel.textContent = 'Mô tả/Phụ đề (không bắt buộc)';
    } else {
        // Thêm câu hỏi: hiển thị dropdown loại câu hỏi
        currentModalType = 'question';
        modalTitle.textContent = 'Thêm câu hỏi mới';
        questionTypeContainer.style.display = 'block';
        contentTypeContainer.style.display = 'none';
        questionTypeSelect.value = defaultType || 'single';
        textLabel.textContent = 'Nội dung câu hỏi';
        textInput.placeholder = 'Nhập câu hỏi';
    }

    const applyTypeUI = function(type) {
        choicesBlock.style.display = (type === 'single' || type === 'multiple') ? 'block' : 'none';
        
        if (type === 'text') {
            subtitleBlock.style.display = 'none';
            mediaBlock.style.display = 'none';
            imageFileBlock.style.display = 'none';
        }

        if (type === 'upload') {
            // Upload question: no choices, no media link, no image file (that's for content block 'image')
            subtitleBlock.style.display = 'none';
            mediaBlock.style.display = 'none';
            imageFileBlock.style.display = 'none';
        }
    };
    
    const getCurrentType = function() {
        if (defaultType === 'section') return 'section';
        if (defaultType === 'image') return 'image';
        if (defaultType === 'video') return 'video';
        if (questionTypeContainer.style.display !== 'none') {
            return questionTypeSelect.value;
        }
        return 'single';
    };
    
    // Chỉ apply khi là câu hỏi
    if (!defaultType || !['section', 'image', 'video'].includes(defaultType)) {
        applyTypeUI(getCurrentType());
    }

    questionTypeSelect.onchange = function() {
        applyTypeUI(this.value);
    };
    
    // Khởi tạo Quill editor cho mô tả/phụ đề
    if (subtitleQuillEditor) {
        subtitleQuillEditor.setText('');
    } else {
        const toolbarOptions = [
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            ['link'],
            ['clean']
        ];
        
        subtitleQuillEditor = new Quill('#subtitle-editor', {
            theme: 'snow',
            modules: {
                toolbar: toolbarOptions
            },
            placeholder: 'Nhập mô tả hoặc phụ đề...'
        });
    }
    
    modal.show();
}

function addNewChoiceInput() {
    const container = document.getElementById('choices-list');
    const count = container.children.length + 1;
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = `
        <input type="text" class="form-control choice-input-new" placeholder="Lựa chọn ${count}">
        <button class="btn btn-outline-danger" type="button" onclick="this.parentElement.remove()">
            <i class="bi bi-x"></i>
        </button>
    `;
    container.appendChild(div);
}

function saveNewQuestion() {
    const text = document.getElementById('new-question-text').value;
    const questionTypeSelect = document.getElementById('new-question-type');
    
    // Xác định type dựa vào currentModalType
    let type;
    if (currentModalType === 'section') {
        type = 'section';
    } else if (currentModalType === 'image') {
        type = 'image';
    } else if (currentModalType === 'video') {
        type = 'video';
    } else {
        type = questionTypeSelect.value;
    }
    
    // Lấy HTML content từ Quill editor
    let subtitle = '';
    if (subtitleQuillEditor) {
        const delta = subtitleQuillEditor.getContents();
        if (delta.ops && delta.ops.length > 0) {
            subtitle = subtitleQuillEditor.root.innerHTML;
        }
    }
    
    const mediaUrl = document.getElementById('new-question-media-link')?.value || '';
    const imageInput = document.getElementById('new-question-image-input');
    const imageFile = imageInput && imageInput.files.length ? imageInput.files[0] : null;
    const choices = Array.from(document.querySelectorAll('.choice-input-new'))
        .map(input => input.value.trim())
        .filter(v => v);
    
    if (!text.trim()) {
        if (currentModalType === 'section' || currentModalType === 'image' || currentModalType === 'video') {
            alert('Vui lòng nhập tiêu đề');
        } else {
            alert('Vui lòng nhập nội dung câu hỏi');
        }
        return;
    }
    
    fetch(`/api/survey/${surveyId}/question/add/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            text: text,
            question_type: type,
            choices: choices,
            is_required: true,
            subtitle: subtitle,
            media_url: mediaUrl
        })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            alert('Lỗi: ' + data.error);
            return;
        }

        // Nếu là loại hình ảnh và có file, upload tiếp
        if (type === 'image' && imageFile) {
            const formData = new FormData();
            formData.append('image', imageFile);
            fetch(`/api/question/${data.question.id}/upload-image/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            })
            .then(res => res.json())
            .then(imgData => {
                if (!imgData.success) {
                    alert('Upload ảnh lỗi: ' + (imgData.error || 'Không rõ'));
                } else {
                    location.reload();
                }
            })
            .catch(() => alert('Không thể upload ảnh, vui lòng thử lại.'));
        } else {
            location.reload();
        }
    });
}

function updateQuestion(questionId, data) {
    fetch(`/api/question/${questionId}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('Lỗi cập nhật:', data.error);
        }
    });
}

function updateQuestionType(questionId, type) {
    const questionItem = document.querySelector(`[data-question-id="${questionId}"]`);
    const choicesContainer = questionItem.querySelector('.choices-container');
    
    if (type !== 'single' && type !== 'multiple') {
        if (choicesContainer) {
            choicesContainer.remove();
        }
        updateQuestion(questionId, {question_type: type});
    } else {
        if (!choicesContainer) {
            const container = document.createElement('div');
            container.className = 'choices-container';
            container.dataset.questionId = questionId;
            container.innerHTML = `
                <div class="choice-item">
                    <i class="bi bi-${type === 'single' ? 'circle' : 'square'}"></i>
                    <input type="text" class="choice-input" placeholder="Lựa chọn" data-choice-id="">
                    <button class="btn-icon" onclick="deleteChoice('')">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <button class="btn btn-sm btn-link p-0 mt-2" onclick="addChoice(${questionId})">
                    <i class="bi bi-plus"></i> Thêm lựa chọn
                </button>
            `;
            questionItem.appendChild(container);
        }
        updateQuestion(questionId, {question_type: type});
    }
}

function addChoice(questionId) {
    const choicesContainer = document.querySelector(`.choices-container[data-question-id="${questionId}"]`);
    const questionType = document.querySelector(`.question-type-select[data-question-id="${questionId}"]`).value;
    
    fetch(`/api/question/${questionId}/choice/add/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({text: ''})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const choiceItem = document.createElement('div');
            choiceItem.className = 'choice-item';
            choiceItem.dataset.choiceId = data.choice.index;
            choiceItem.innerHTML = `
                <i class="bi bi-${questionType === 'single' ? 'circle' : 'square'}"></i>
                <input type="text" class="choice-input" value="${data.choice.text}" 
                       placeholder="Lựa chọn" data-choice-id="${data.choice.index}">
                ${surveyIsQuiz ? `
                <button class="btn-icon correct-toggle" type="button" data-choice-index="${data.choice.index}"
                        onclick="toggleCorrectAnswer(${questionId}, ${data.choice.index}, this)" title="Đáp án đúng">
                    <i class="bi bi-star-fill"></i>
                </button>` : ''}
                <button class="btn-icon" onclick="deleteChoice(${questionId}, ${data.choice.index})">
                    <i class="bi bi-x"></i>
                </button>
            `;
            const addBtn = choicesContainer.querySelector('button');
            choicesContainer.insertBefore(choiceItem, addBtn);
            
            // Auto-save for new input
            const input = choiceItem.querySelector('.choice-input');
            let timeout;
            input.addEventListener('input', function() {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    updateChoice(this.dataset.choiceId, this.value);
                }, 1000);
            });
        }
    });
}

// Toggle correct answer for Quiz mode
function toggleCorrectAnswer(questionId, choiceIndex, btn) {
    if (!surveyIsQuiz) return;

    btn.classList.toggle('text-warning');
    const questionItem = btn.closest('.question-item');
    const toggles = questionItem.querySelectorAll('.correct-toggle');
    const correct = [];
    toggles.forEach(el => {
        if (el.classList.contains('text-warning')) {
            const idx = parseInt(el.dataset.choiceIndex, 10);
            if (!Number.isNaN(idx)) {
                correct.push(idx);
            }
        }
    });

    updateQuestion(questionId, {correct_answers: correct});
}

function updateChoice(choiceId, text) {
    if (!choiceId) return;
    // Update choice via question update API
    const choiceItem = document.querySelector(`[data-choice-id="${choiceId}"]`);
    const questionId = choiceItem.closest('.question-item').dataset.questionId;
    const choices = Array.from(choiceItem.closest('.choices-container').querySelectorAll('.choice-input'))
        .map(input => ({id: input.dataset.choiceId, text: input.value}));
    
    // We'll update the whole question with all choices
    const choicesData = choices.filter(c => c.id).map(c => c.text);
    updateQuestion(questionId, {choices: choicesData});
}

function deleteChoice(questionId, choiceIndex) {
    if (choiceIndex === undefined || choiceIndex === null) {
        event.target.closest('.choice-item').remove();
        return;
    }
    
    if (confirm('Bạn có chắc muốn xóa lựa chọn này?')) {
        fetch(`/api/choice/${questionId}/delete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({index: choiceIndex})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector(`[data-choice-id="${choiceIndex}"]`).remove();
            }
        });
    }
}

function deleteQuestion(questionId) {
    if (confirm('Bạn có chắc muốn xóa câu hỏi này?')) {
        fetch(`/api/question/${questionId}/delete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelector(`[data-question-id="${questionId}"]`).remove();
                updateQuestionNumbers();
            }
        });
    }
}

function toggleRequired(questionId, checkboxEl) {
    const isRequired = checkboxEl.checked;
    updateQuestion(questionId, {is_required: isRequired});
}

function duplicateQuestion(questionId) {
    const item = document.querySelector(`[data-question-id="${questionId}"]`);
    if (!item) return;

    const textInput = item.querySelector('.question-text');
    const typeSelect = item.querySelector('.question-type-select');
    const requiredToggle = item.querySelector('.required-toggle');

    const text = textInput ? textInput.value : '';
    const questionType = typeSelect ? typeSelect.value : 'text';
    const isRequired = requiredToggle ? requiredToggle.checked : false;

    let choices = [];
    if (questionType === 'single' || questionType === 'multiple') {
        choices = Array.from(item.querySelectorAll('.choice-input'))
            .map(input => input.value.trim())
            .filter(Boolean);
    }

    fetch(`/api/survey/${surveyId}/question/add/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            text: text || 'Bản sao câu hỏi',
            question_type: questionType,
            is_required: isRequired,
            choices: choices,
            order: document.querySelectorAll('.question-item').length + 1
        })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.error || 'Không thể nhân bản câu hỏi');
        }
    })
    .catch(() => alert('Không thể kết nối server'));
}

function saveQuestionOrder() {
    const items = Array.from(document.querySelectorAll('.question-item'));
    const orders = items.map((item, index) => ({
        id: parseInt(item.dataset.questionId),
        order: index + 1
    }));
    
    fetch(`/api/survey/${surveyId}/question/reorder/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({orders: orders})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateQuestionNumbers();
        }
    });
}

function updateQuestionNumbers() {
    document.querySelectorAll('.question-number').forEach((el, index) => {
        el.textContent = (index + 1) + '.';
    });
}

// Animate progress bars on page load
function animateProgressBars() {
    const progressBars = document.querySelectorAll('.progress-bar[data-percentage]');
    
    // Use setTimeout to ensure DOM is ready
    setTimeout(() => {
        progressBars.forEach((bar, index) => {
            const percentage = parseFloat(bar.dataset.percentage);
            
            // Stagger animation for multiple bars
            setTimeout(() => {
                bar.style.width = percentage + '%';
                
                // Force 100% to be truly full width
                if (percentage === 100 || percentage >= 99.9) {
                    bar.classList.add('full-width');
                    bar.style.width = '100%';
                }
            }, index * 100); // 100ms delay between each bar
        });
    }, 100);
}

// Generate beautiful colors
function generateColors(count) {
    const colors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF9F40',
        '#36A2EB', '#FFCE56', '#9966FF', '#FF6384', '#36A2EB'
    ];
    return colors.slice(0, count);
}

// Create chart
function createChart(chartId, type = 'doughnut') {
    const canvas = document.getElementById(`chart-${chartId}`);
    if (!canvas) return;
    
    const data = chartData[chartId];
    if (!data) return;
    
    // Destroy existing chart if any
    if (chartInstances[chartId]) {
        chartInstances[chartId].destroy();
    }
    
    const ctx = canvas.getContext('2d');
    
    const config = {
        type: type,
        data: {
            labels: data.labels,
            datasets: [{
                data: data.data,
                backgroundColor: generateColors(data.labels.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        font: {
                            size: 12
                        },
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return {
                                        text: `${label}: ${value} (${percentage}%)`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        hidden: false,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || context.raw;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value} (${percentage}%)`;
                        }
                    }
                }
            },
            animation: {
                animateScale: true,
                animateRotate: true,
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    };
    
    // Adjust options for bar chart
    if (type === 'bar') {
        config.options.scales = {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        };
        config.options.plugins.legend.display = false;
    }
    
    chartInstances[chartId] = new Chart(ctx, config);
}

// Switch chart type
function switchChart(chartId, type) {
    // Update button states
    const buttons = event.target.closest('.btn-group').querySelectorAll('.btn');
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Recreate chart with new type
    createChart(chartId, type);
}

// Initialize all charts
function initCharts() {
    Object.keys(chartData).forEach(chartId => {
        createChart(chartId, 'doughnut');
    });
}

// Run animation when results tab is shown
document.addEventListener('DOMContentLoaded', function() {
    animateProgressBars();
    
    // Also animate when switching to results tab
    const resultsTab = document.getElementById('results-tab');
    if (resultsTab) {
        resultsTab.addEventListener('shown.bs.tab', function() {
            animateProgressBars();
            initCharts();
        });
    }

    // Handle allow_review_response and send_confirmation_email interaction in Settings tab
    const allowReviewCheckbox = document.getElementById('id_allow_review_response');
    const sendEmailCheckbox = document.getElementById('id_send_confirmation_email');
    const emailHelpText = document.getElementById('emailHelpTextBuilder');
    
    if (allowReviewCheckbox && sendEmailCheckbox) {
        function updateEmailCheckboxState() {
            if (allowReviewCheckbox.checked) {
                // Nếu bật xem lại câu trả lời → tắt và disable email
                sendEmailCheckbox.checked = false;
                sendEmailCheckbox.disabled = true;
                sendEmailCheckbox.parentElement.style.opacity = '0.5';
                if (emailHelpText) {
                    emailHelpText.innerHTML = '<span class="text-warning"><i class="bi bi-info-circle"></i> Tính năng này bị vô hiệu hóa khi BẬT "Cho phép xem lại câu trả lời"</span>';
                }
            } else {
                // Nếu tắt xem lại câu trả lời → enable email
                sendEmailCheckbox.disabled = false;
                sendEmailCheckbox.parentElement.style.opacity = '1';
                if (emailHelpText) {
                    emailHelpText.innerHTML = 'Gửi email cảm ơn đến người trả lời (chỉ hoạt động khi TẮT tính năng xem lại câu trả lời)';
                }
            }
        }
        
        // Chạy khi trang load
        updateEmailCheckboxState();
        
        // Chạy khi thay đổi
        allowReviewCheckbox.addEventListener('change', updateEmailCheckboxState);
    }
});
</script>
{% endblock %}

